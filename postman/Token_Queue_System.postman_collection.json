{
    "info": {
        "_postman_id": "token-queue-flow-2026",
        "name": "GTS Token Queue System Testing",
        "description": "Test collection for Token Queue System flow including login, stock request, approval, and driver token operations.",
        "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
    },
    "variable": [
        {
            "key": "base_url",
            "value": "http://localhost:8001/api",
            "type": "string"
        },
        {
            "key": "eic_token",
            "value": "",
            "type": "string"
        },
        {
            "key": "driver_token",
            "value": "",
            "type": "string"
        },
        {
            "key": "dbs_token",
            "value": "",
            "type": "string"
        },
        {
            "key": "ms_id",
            "value": "1",
            "type": "string"
        },
        {
            "key": "dbs_id",
            "value": "2",
            "type": "string"
        },
        {
            "key": "stock_request_id",
            "value": "",
            "type": "string"
        }
    ],
    "item": [
        {
            "name": "1. Authentication",
            "item": [
                {
                    "name": "1.1 Login as EIC",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "var jsonData = pm.response.json();",
                                    "if (jsonData.token) {",
                                    "    pm.collectionVariables.set('eic_token', jsonData.token);",
                                    "    console.log('EIC Token saved');",
                                    "}",
                                    "if (jsonData.user && jsonData.user.station) {",
                                    "    pm.collectionVariables.set('ms_id', jsonData.user.station.id);",
                                    "}"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"email\": \"eic@example.com\",\n    \"password\": \"your_password\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/auth/login/",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "auth",
                                "login",
                                ""
                            ]
                        },
                        "description": "Login as EIC user to get auth token"
                    }
                },
                {
                    "name": "1.2 Login as Driver",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "var jsonData = pm.response.json();",
                                    "if (jsonData.token) {",
                                    "    pm.collectionVariables.set('driver_token', jsonData.token);",
                                    "    console.log('Driver Token saved');",
                                    "}"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"email\": \"driver@example.com\",\n    \"password\": \"your_password\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/auth/login/",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "auth",
                                "login",
                                ""
                            ]
                        },
                        "description": "Login as Driver to get auth token"
                    }
                },
                {
                    "name": "1.3 Login as DBS Operator",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "var jsonData = pm.response.json();",
                                    "if (jsonData.token) {",
                                    "    pm.collectionVariables.set('dbs_token', jsonData.token);",
                                    "    console.log('DBS Token saved');",
                                    "}",
                                    "if (jsonData.user && jsonData.user.station) {",
                                    "    pm.collectionVariables.set('dbs_id', jsonData.user.station.id);",
                                    "}"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"email\": \"dbs@example.com\",\n    \"password\": \"your_password\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/auth/login/",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "auth",
                                "login",
                                ""
                            ]
                        },
                        "description": "Login as DBS Operator to get auth token"
                    }
                }
            ]
        },
        {
            "name": "2. Stock Request (DBS)",
            "item": [
                {
                    "name": "2.1 Create Stock Request",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "var jsonData = pm.response.json();",
                                    "if (jsonData.id) {",
                                    "    pm.collectionVariables.set('stock_request_id', jsonData.id);",
                                    "    console.log('Stock Request ID saved: ' + jsonData.id);",
                                    "}"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{dbs_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"requested_qty_kg\": 500,\n    \"current_stock_kg\": 100,\n    \"requested_by_date\": \"2026-01-07\",\n    \"requested_by_time\": \"14:00:00\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/stock-requests/",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "stock-requests",
                                ""
                            ]
                        },
                        "description": "DBS operator creates a stock request"
                    }
                },
                {
                    "name": "2.2 Get My Stock Requests",
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{dbs_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/dbs/stock-requests",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "dbs",
                                "stock-requests"
                            ]
                        },
                        "description": "List stock requests for DBS"
                    }
                }
            ]
        },
        {
            "name": "3. EIC Approval",
            "item": [
                {
                    "name": "3.1 Get Pending Stock Requests",
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{eic_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/eic/stock-requests/?status=PENDING",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "eic",
                                "stock-requests",
                                ""
                            ],
                            "query": [
                                {
                                    "key": "status",
                                    "value": "PENDING"
                                }
                            ]
                        },
                        "description": "EIC views pending stock requests"
                    }
                },
                {
                    "name": "3.2 Approve Request (Queue Mode)",
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{eic_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"status\": \"APPROVED\",\n    \"notes\": \"Approved via token queue\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/eic/stock-requests/{{stock_request_id}}/approve/",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "eic",
                                "stock-requests",
                                "{{stock_request_id}}",
                                "approve",
                                ""
                            ]
                        },
                        "description": "Approve WITHOUT driver - enters queue for auto-allocation"
                    }
                },
                {
                    "name": "3.3 View Token Queue",
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{eic_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/eic/token-queue?ms_id={{ms_id}}",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "eic",
                                "token-queue"
                            ],
                            "query": [
                                {
                                    "key": "ms_id",
                                    "value": "{{ms_id}}"
                                }
                            ]
                        },
                        "description": "View waiting tokens and pending requests at MS"
                    }
                },
                {
                    "name": "3.4 Manual Allocation (Override)",
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{eic_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"token_id\": 1,\n    \"stock_request_id\": {{stock_request_id}}\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/eic/token-queue/allocate",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "eic",
                                "token-queue",
                                "allocate"
                            ]
                        },
                        "description": "EIC manually allocates specific token to specific request"
                    }
                }
            ]
        },
        {
            "name": "4. Driver Token Queue",
            "item": [
                {
                    "name": "4.1 Request Token at MS",
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{driver_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"ms_id\": {{ms_id}}\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/driver/token/request",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "driver",
                                "token",
                                "request"
                            ]
                        },
                        "description": "Driver requests queue token at Mother Station. Requires active shift."
                    }
                },
                {
                    "name": "4.2 Get Current Token",
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{driver_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/driver/token/current",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "driver",
                                "token",
                                "current"
                            ]
                        },
                        "description": "Get driver's current token status (WAITING or ALLOCATED)"
                    }
                },
                {
                    "name": "4.3 Cancel Token",
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{driver_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{}"
                        },
                        "url": {
                            "raw": "{{base_url}}/driver/token/cancel",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "driver",
                                "token",
                                "cancel"
                            ]
                        },
                        "description": "Driver cancels waiting token (leaves queue)"
                    }
                }
            ]
        },
        {
            "name": "5. Verify Flow",
            "item": [
                {
                    "name": "5.1 Get Active Trips",
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{eic_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/trips/?status=PENDING,AT_MS,IN_TRANSIT,AT_DBS",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "trips",
                                ""
                            ],
                            "query": [
                                {
                                    "key": "status",
                                    "value": "PENDING,AT_MS,IN_TRANSIT,AT_DBS"
                                }
                            ]
                        },
                        "description": "Check if trip was created after auto-allocation"
                    }
                },
                {
                    "name": "5.2 Get Stock Request Details",
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{eic_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/eic/stock-requests/{{stock_request_id}}/",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "eic",
                                "stock-requests",
                                "{{stock_request_id}}",
                                ""
                            ]
                        },
                        "description": "Check stock request status and allocated_vehicle_token"
                    }
                },
                {
                    "name": "5.3 EIC Dashboard",
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{eic_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/eic/dashboard",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "eic",
                                "dashboard"
                            ]
                        },
                        "description": "View EIC dashboard summary"
                    }
                }
            ]
        }
    ]
}