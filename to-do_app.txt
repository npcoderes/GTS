✅ 0. LOGIN FLOW (ALL ROLES)
Step 1: User enters email + password
Backend checks:

READ → users table

email

password_hash

is_active

Logic:

Hash input password

Compare with users.password_hash

Step 2: Fetch user’s role
Backend checks:

READ → user_roles

user_id

role_id

station_id (if operator)

active = true

READ → roles

role code → MS_OPERATOR / DBS_OPERATOR / DRIVER etc.

Step 3: Permission & Station Mapping

If role is:

MS Operator → assign MS station

DBS Operator → assign DBS station

Driver → fetch driver_id from drivers

Output to app:

User profile

Role list

Station details

Permissions

✅ 1. DBS OPERATOR PROCESSES
1.1 DBS Dashboard

Shows all trips assigned to THIS DBS.

Backend:

READ → trips
Filter:

dbs_id = user.station_id

status in (PENDING, AT_DBS, COMPLETED, DISPATCHED)

Also:
READ → vehicles
READ → drivers

1.2 Manual Request (DBS raises request)
User inputs:

Requested quantity

Current stock

Rate of sale

DOT

RLT

Backend:

WRITE → stock_requests
Fields saved:

dbs_id

source = DBS_OPERATOR

requested_qty_kg

current_stock_kg

rate_of_sale_kg_per_min

dot_minutes

rlt_minutes

created_at

requested_by_user_id

1.3 DBS Transfer Screen

This shows MS → DBS gas movement.

Backend:

READ → trips (trip summary)
READ → ms_filling (filled qty)
READ → dbs_decanting (delivered qty)
READ → reconciliation (variance)

1.4 Decanting Process
STEP 1: Confirm Truck Arrival

Backend:
UPDATE → trips

status = AT_DBS

dbs_arrival_at = now()

STEP 2: Pre-Decant Readings

Input:

pre-dec reading

pressure

flow

Backend:
WRITE/UPDATE → dbs_decanting

trip_id

start_time

pre_dec_reading

STEP 3: Post-Decant + Delivered Qty

Input:

post-dec reading

delivered qty

Backend:
UPDATE → dbs_decanting

post_dec_reading

end_time

delivered_qty_kg

confirmed_by_dbs_operator

confirmed_by_driver

Also:
UPDATE → reconciliation

dbs_delivered_qty_kg

If SAP push:
WRITE → sap_events

✅ 2. MS OPERATOR PROCESSES
2.1 MS Dashboard

Shows trips going OUT of MS.

Backend:
READ → trips where ms_id = user.station_id
READ → vehicles, drivers, tokens, proposals

2.2 MS Filling (Major Process)
STEP 1: Confirm Truck Arrival

Backend:
UPDATE → trips

origin_confirmed_at

status = AT_MS

STEP 2: Pre Meter Reading

User inputs:

prefill MFM

prefill pressure

Backend:
WRITE → ms_filling

trip_id

start_time

prefill_pressure_bar

prefill_mfm

STEP 3: Post Meter Reading

User inputs:

postfill MFM

postfill pressure

Backend:
UPDATE → ms_filling

postfill_mfm

postfill_pressure_bar

end_time

filled_qty_kg (system calculated)

STEP 4: Confirm & Post to SAP

Backend:
UPDATE → ms_filling

confirmed_by_ms_operator

confirmed_by_driver

SAP:
WRITE → sap_events

event_type = MS_FILL_CONFIRMATION

2.3 Stock Transfer Summary

Backend:
READ → trips, ms_filling, dbs_decanting, reconciliation

✅ 3. EIC (ADMIN) PROCESSES
3.1 Network Dashboard

Backend:
READ → stations
READ → ms_dbs_map
READ → routes

3.2 Stock Requests List

Backend:
READ → stock_requests
READ → credit_checks

3.3 Driver Approval

User actions:

Approve

Reject

Backend:
UPDATE → drivers

status = ACTIVE / INACTIVE / SUSPENDED

READ → driver_shift
READ → partners, vehicles

3.4 Cluster Management

User can:

Add/Edit MS

Add/Edit DBS

Add mapping

Backend:
WRITE/UPDATE → stations
WRITE/UPDATE → ms_dbs_map

3.5 Manual Token Assignment

Inputs:

Customer ID

Customer Name

MS

DBS

Backend:
WRITE → proposals
WRITE → tokens
(proposal auto-creates the trip pipeline)

3.6 Stock Transfer Summary

Same as MS/DBS:
READ → trips, ms_filling, dbs_decanting, reconciliation

✅ 4. SGL CUSTOMER PROCESSES
4.1 Dashboard

Shows:

Recent trips

Filling

Completed
Backend:
READ → trips filtered by dbs_id

4.2 Stock Levels

If SCADA available:
READ → scada_snapshots (latest)

If Manual:
READ → stock_requests.current_stock_kg

4.3 Transport Tracking

Backend:
READ → vts_positions
READ → vehicles
READ → trips

4.4 Stock Transfers

Backend:
READ → trips, ms_filling, dbs_decanting

✅ 5. DRIVER PROCESSES
5.1 Driver Trip List

Backend:
READ → trips WHERE driver_id = current driver

5.2 Accept/Reject Trip

Backend:
UPDATE → trips

driver_id

status = AT_MS or ACTIVE

5.3 MS Arrival + Readings

Backend:
UPDATE → trips.origin_confirmed_at
WRITE → ms_filling prefill fields

5.4 Navigation MS → DBS

Backend:
Every location update:
WRITE → vts_positions

Deviation check:
WRITE → route_deviation_events

5.5 DBS Arrival + Readings

Backend:
UPDATE → trips.dbs_arrival_at
WRITE → dbs_decanting.pre_dec_reading
Later:
UPDATE → dbs_decanting.post_dec_reading

5.6 Complete Trip

Backend:
UPDATE → trips.completed_at
UPDATE → reconciliation
WRITE → sap_events (if SAP GR done)